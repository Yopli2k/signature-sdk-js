import{M as Module,c as com}from"./stu-sdk.min-DAnsK4yV.js";import{S as SigCaptDialog,a as StuCaptDialog}from"./stuCaptDialog-DTTpjUjJ.js";import{M as MyEncryptionHandler,a as MyEncryptionHandler2}from"./stu_capture_encryption-DRW1D5Xh.js";class SignSDKHelper{constructor(e){this.sigSDK=e}integrityStatusDesc(e){switch(e){case this.sigSDK.IntegrityStatus.OK:return"Integrity correct";case this.sigSDK.IntegrityStatus.FAIL:return"Signature tampered";case this.sigSDK.IntegrityStatus.MISSING:return"The signature has no integrity data";case this.sigSDK.IntegrityStatus.WRONG_TYPE:return"The type of the key is incorrect, please try with another type";case this.sigSDK.IntegrityStatus.INSUFFICIENT_DATA:return"Insufficient data";case this.sigSDK.IntegrityStatus.UNCERTAIN:return"The integrity is uncertain";case this.sigSDK.IntegrityStatus.NOT_SUPPORTED:return"The integrity type is not supported in this version of Signature SDK"}}dataStatusDesc(e){switch(e){case this.sigSDK.DataStatus.GOOD:return"Signed data correct";case this.sigSDK.DataStatus.NO_HASH:return"The signature has not attached any data";case this.sigSDK.DataStatus.BAD_TYPE:return"The type of the hash is incorrect, please try with another type";case this.sigSDK.DataStatus.BAD_HASH:return"The hash of the document is different from the provided";case this.sigSDK.DataStatus.ERROR:return"Unknown error";case this.sigSDK.DataStatus.UNCERTAIN:return"The data is uncertain";case this.sigSDK.DataStatus.SIG_MOVED:return"The signature has been moved"}}isEncryptedBinary(e){var n=new TextDecoder().decode(e);return n.startsWith("wgssAES_")||n.startsWith("wgssRSA_")}}let sigSDK,mSigObj,documentHash,backgroundImage,sigCaptDialog,stuCapDialog,sigSDKHelper;"addEventListener"in document&&document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("capture_canvas_btn");t.addEventListener("touchend",function(e){return event.preventDefault(),t.click(),!1},!1)},!1);try{sigSDK=await new Module,sigSDKHelper=new SignSDKHelper(sigSDK),document.getElementById("version_txt").innerHTML=sigSDK.VERSION,documentHash=new sigSDK.Hash(sigSDK.HashType.None),mSigObj=new sigSDK.SigObj;const t=mSigObj.setLicence("7c31f853-d5dd-48f1-8414-5ffe3c412f32","vi/z9ICyX1MB8sXMRdVhhN+XdVwovycD1jdE0PtWMejrQVSakuEoHNSgyi3sbdBuXTn7yZZ1jaokpuvA5yehfQ==");t.then(e=>{e&&(navigator.hid&&(document.getElementById("capture_stu_btn").disabled=!1),document.getElementById("capture_canvas_btn").disabled=!1,document.getElementById("document").disabled=!1,document.getElementById("load_signature").disabled=!1,document.getElementById("initializeBanground").style.display="none",setDeviceName())}),t.catch(e=>{alert(e),document.getElementById("initializeBanground").style.display="none"})}catch(t){alert("Error initializing SigSDK "+t),document.getElementById("initializeBanground").style.display="none"}function generateConfig(){const config={};config.strokeSize=parseInt(document.getElementById("ink_width").value),config.strokeColor=document.getElementById("rendering_color_box").value,config.width=document.getElementById("dialog_width").value,config.height=document.getElementById("dialog_height").value,config.left=document.getElementById("dialog_left").value+"px",config.top=document.getElementById("dialog_top").value+"px",config.centered=document.getElementById("is_centered").checked,config.title=document.getElementById("title_text").value,config.borderColor=document.getElementById("border_color_box").value,config.borderWidth=document.getElementById("border_width_box").value,config.hasTitle=document.getElementById("has_title_check").checked,config.signatory={visible:document.getElementById("show_signatory_check").checked,fontFace:document.getElementById("signatory_font_type_text").value,fontSize:parseInt(document.getElementById("signatory_font_size_text").value),offsetX:parseInt(document.getElementById("signatory_offset_x_text").value),offsetY:parseInt(document.getElementById("signatory_offset_y_text").value),color:document.getElementById("signatory_color_box").value},config.reason={visible:document.getElementById("show_reason_check").checked,fontFace:document.getElementById("reason_font_type_text").value,fontSize:parseInt(document.getElementById("reason_font_size_text").value),offsetX:parseInt(document.getElementById("reason_offset_x_text").value),offsetY:parseInt(document.getElementById("reason_offset_y_text").value),color:document.getElementById("reason_color_box").value},config.date={visible:document.getElementById("show_date_check").checked,fontFace:document.getElementById("date_font_type_text").value,fontSize:parseInt(document.getElementById("date_font_size_text").value),offsetX:parseInt(document.getElementById("date_offset_x_text").value),offsetY:parseInt(document.getElementById("date_offset_y_text").value),color:document.getElementById("date_color_box").value},config.signingLine={visible:document.getElementById("show_signing_line_check").checked,left:parseInt(document.getElementById("signing_line_left_text").value),right:parseInt(document.getElementById("signing_line_right_text").value),width:parseInt(document.getElementById("signing_line_width_text").value),offsetY:parseInt(document.getElementById("signing_line_offset_y_text").value),color:document.getElementById("signing_line_color_box").value},config.buttonsFont=document.getElementById("button_font_type").value,config.buttons=[];const fields=document.getElementById("button_list_div").getElementsByTagName("fieldset");for(var i=0;i<fields.length;i++)config.buttons.push({text:fields[i].elements.namedItem("button_text").value,textColor:fields[i].elements.namedItem("button_text_color").value,backgroundColor:fields[i].elements.namedItem("button_background_color").value,borderColor:fields[i].elements.namedItem("button_border_color").value,borderWidth:parseInt(fields[i].elements.namedItem("button_border_width").value),onClick:eval(fields[i].elements.namedItem("button_action").value)});document.getElementById("shows_as_dialog").checked||(config.attachTo="captureDiv");const comboSizeModes=document.getElementById("stu_fit_mode");config.sizeMode=comboSizeModes.options[comboSizeModes.selectedIndex].value,config.modal=document.getElementById("shows_modal").checked,config.draggable=document.getElementById("is_draggable").checked,document.getElementById("inking_tool"),document.getElementById("rendering_color_box").value;const comboBackgroundMode=document.getElementById("background_image_mode");if(config.background={color:document.getElementById("background_color_box").value,alpha:document.getElementById("background_opacity").value*.01,mode:comboBackgroundMode.options[comboBackgroundMode.selectedIndex].value},document.getElementById("put_background_image").checked&&backgroundImage&&(config.background.image=backgroundImage),document.getElementById("enable_timeout").checked&&(config.timeOut={enabled:!0},config.timeOut.time=parseInt(document.getElementById("timeOutValue").value),config.timeOut.onTimeOut=timeOutCallback),config.minTimeOnSurface=parseInt(document.getElementById("minTimeOnSurface").value),!document.getElementById("allowOutSide").checked){const t=this;config.onOutSide=function(){return alert("OutSide stroke is not allowed. Please sign again"),t.clear(),!0}}return config.allowZeroPressure=document.getElementById("allowZeroPressure").checked,config}window.capture=async function(t){if(!document.getElementById("shows_as_dialog").checked){let e=document.getElementById("captureDiv");e.style.width=document.getElementById("dialog_width").value+"px",e.style.height=document.getElementById("dialog_height").value+"px"}document.getElementById("signatureImage").style.display="none",document.getElementById("captureDiv").style.display="block",document.getElementById("save_image_btn").disabled=!0,document.getElementById("save_text_btn").disabled=!0,document.getElementById("save_binary_btn").disabled=!0,document.getElementById("save_iso_binary_btn").disabled=!0,document.getElementById("save_iso_xml_btn").disabled=!0,t=="STU"?await captureFromSTU():captureFromCanvas()};function captureFromCanvas(){stuCapDialog=null;const t=generateConfig();t.source={mouse:document.getElementById("allow_mouse_check").checked,touch:document.getElementById("allow_touch_check").checked,pen:document.getElementById("allow_pen_check").checked},sigCaptDialog=new SigCaptDialog(sigSDK,t),sigCaptDialog.addEventListener("ok",function(){encryptSignature(),renderSignature()}),sigCaptDialog.open(mSigObj,document.getElementById("who").value,document.getElementById("why").value,generateExtraData(),sigSDK.KeyType.SHA512,documentHash),sigCaptDialog.startCapture()}async function captureFromSTU(){sigCaptDialog=null;const t=generateConfig();document.getElementById("encrypt_stu").checked&&(t.encryption={sessionId:window.crypto.getRandomValues(new Uint32Array(1))[0],encryptionHandler:new MyEncryptionHandler,encryptionHandler2:new MyEncryptionHandler2});const e=localStorage.getItem("stuDevice");let n;if(e)n=JSON.parse(e),await navigator.hid.getDevices().then(a=>{a.forEach(d=>{n.vendorId===d.vendorId&&n.productId===d.productId&&n.productName===d.productName&&(n=d)})});else{const a=await com.WacomGSS.STU.UsbDevice.requestDevices();if(a.length>0)n=a[0],localStorage.setItem("stuDevice",JSON.stringify({vendorId:n.vendorId,productName:n.productName,productId:n.productId})),setDeviceName();else throw"No STU devices found"}t.stuDevice=n,stuCapDialog=new StuCaptDialog(sigSDK,t),stuCapDialog.addEventListener("ok",function(){encryptSignature(),renderSignature()}),stuCapDialog.open(mSigObj,document.getElementById("who").value,document.getElementById("why").value,generateExtraData(),sigSDK.KeyType.SHA512,documentHash)}window.setDeviceName=function(){const t=localStorage.getItem("stuDevice");t?document.getElementById("selectedStuDevice").innerHTML=JSON.parse(t).productName:document.getElementById("selectedStuDevice").innerHTML="None"};window.removeDevice=function(){localStorage.removeItem("stuDevice"),setDeviceName()};window.clear=function(){stuCapDialog&&stuCapDialog.clear(),sigCaptDialog&&sigCaptDialog.clear()};function cancel(){stuCapDialog&&stuCapDialog.cancel(),sigCaptDialog&&sigCaptDialog.cancel()}function accept(){stuCapDialog&&stuCapDialog.accept(),sigCaptDialog&&(stuCapDialog?sigCaptDialog.cancel():sigCaptDialog.accept())}function mmToPx(t){var e=window.devicePixelRatio,n=25.4,a=96;return t/n*a/e}async function renderSignatureImage(){let t=parseInt(document.getElementById("render_width").value),e=parseInt(document.getElementById("render_height").value);const n=document.getElementById("is_relative").checked;let a=4194304;if(n){a|=33554432;const l=96/25.4*2;t=Math.floor(mmToPx(mSigObj.getWidth(!0)/100)+l),e=Math.floor(mmToPx(mSigObj.getHeight(!0)/100)+l)}else{if(isNaN(t)||t<=0)if(isNaN(e)||e<=0)t=mmToPx(mSigObj.getWidth(!1)/100),e=mmToPx(mSigObj.getHeight(!1)/100);else{const l=mmToPx(mSigObj.getWidth()/100),c=mmToPx(mSigObj.getHeight()/100);t=l/c*e}else if(isNaN(e)||e<=0){const l=mmToPx(mSigObj.getWidth()/100);e=mmToPx(mSigObj.getHeight()/100)/l*t}t=Math.floor(t),e=Math.floor(e),t+=t%4}const d="transparent";n&&(t=-96,e=-96);const o=document.getElementById("rendering_color_box").value,r=parseInt(document.getElementById("ink_width").value);return await mSigObj.renderBitmap(t,e,"image/png",r,o,d,0,0,a)}async function renderSignature(){const t=await renderSignatureImage();document.getElementById("captureDiv").style.display="none",document.getElementById("signatureImage").src=t,document.getElementById("signatureImage").style.display="block",document.getElementById("save_image_btn").disabled=!1,document.getElementById("save_text_btn").disabled=!1,document.getElementById("save_binary_btn").disabled=!1,document.getElementById("save_iso_binary_btn").disabled=!1,document.getElementById("save_iso_xml_btn").disabled=!1}window.saveSignature=async function(t){const e=document.createElement("a");if(t=="image")e.download="signature.png",e.href=document.getElementById("signatureImage").src;else{let n;if(t=="txt")e.download="signature.txt",n=new Blob([await mSigObj.getTextData(sigSDK.TextFormat.BASE64)],{type:"text/plain"});else if(t=="binary")e.download="signature.fss",n=new Blob([await mSigObj.getSigData()],{type:"application/octet-stream"});else if(t=="iso_binary"){e.download="signature.iso";let a=sigSDK.IsoType["ISO-19794-7_BINARY"];mSigObj.canEncrypt()&&(document.getElementById("iso_encrypted_binary_radio").checked?(e.download="signature_encrypted.iso",a=sigSDK.IsoType["ISO-19794-7_ENCRYPTED_BINARY"]):(e.download="signature_encrypted_iso.txt",a=sigSDK.IsoType["ISO-19794-7_ENCRYPTED_TEXT"])),n=new Blob([await mSigObj.exportIso(a)],{type:"application/octet-stream"})}else t=="iso_xml"&&(e.download="signature.xml",mSigObj.canEncrypt()&&alert("XML ISO-19785-3 cannot be encrypted, it will be saved without encryption"),n=new Blob([await mSigObj.exportIso(sigSDK.IsoType["ISO-19785-3_XML"])],{type:"application/octet-stream"}));window.webkitURL!=null?e.href=window.webkitURL.createObjectURL(n):(e.href=window.URL.createObjectURL(n),e.style.display="none",document.body.appendChild(e))}e.click(),e.remove()};window.addDocumentHash=async function(){const t=new FileReader;t.onload=async function(){try{documentHash.delete();const e=t.result,n=sigSDK.HashType.SHA512;documentHash=new sigSDK.Hash(n);const a=await crypto.subtle.digest("SHA-512",e);documentHash.setHash(a)}catch(e){alert(e)}},t.readAsArrayBuffer(document.getElementById("document").files[0])};window.loadSignature=async function(){try{await mSigObj.setPublicKey(""),await mSigObj.setPrivateKey(""),await mSigObj.setEncryptionPassword(""),await decryptSignature(mSigObj)}catch(e){console.log(e)}const t=document.getElementById("load_signature").files[0];if(t)if(t.type=="text/plain"||t.type=="text/xml"){const e=new FileReader;e.onload=async function(){const n=e.result;if(t.type=="text/plain"){if(!await mSigObj.setTextData(n)||!await readSignature(!1))try{const a=new sigSDK.AdditionalImportIsoData;a.setWho("User imported from ISO"),a.setWhy("Signature imported from ISO"),await mSigObj.importIso(n,sigSDK.IsoType["ISO-19794-7_ENCRYPTED_TEXT"],a),readSignature(!0)}catch(a){document.getElementById("load_signature").value=null,alert(a)}}else{const a=new sigSDK.AdditionalImportIsoData;a.setWho("User imported from XML ISO"),a.setWhy("Signature imported from XML ISO");const r=new DOMParser().parseFromString(n,"text/xml").getElementsByTagName("CreationDate");r.length>0&&a.setWhen(new Date(r[0].innerHTML)),await mSigObj.importIso(n,sigSDK.IsoType["ISO-19785-3_XML"],a),readSignature(!0)}},e.readAsText(t)}else if(t.type=="image/png"){const e=new FileReader;e.onload=async function(){const n=e.result;var a=new Image;a.addEventListener("load",async function(){const o=document.createElement("canvas").getContext("webgl2");o.activeTexture(o.TEXTURE0);const r=o.createTexture();o.bindTexture(o.TEXTURE_2D,r);const s=o.createFramebuffer();o.bindFramebuffer(o.FRAMEBUFFER,s),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,r,0),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,this),o.drawBuffers([o.COLOR_ATTACHMENT0]);const l=new Uint8Array(this.width*this.height*4);o.readPixels(0,0,this.width,this.height,o.RGBA,o.UNSIGNED_BYTE,l);try{await mSigObj.readEncodedBitmapBinary(l,a.width,a.height),readSignature(!0)}catch(c){document.getElementById("load_signature").value=null,alert(c)}},!1),a.src=n},e.readAsDataURL(t)}else{const e=new FileReader;e.onload=async function(){const n=e.result;try{if(!await mSigObj.setSigData(new Uint8Array(n))||!await readSignature(!1)){const a=new sigSDK.AdditionalImportIsoData;a.setWho("User imported from ISO"),a.setWhy("Signature imported from ISO"),await mSigObj.importIso(new Uint8Array(n),sigSDKHelper.isEncryptedBinary(n)?sigSDK.IsoType["ISO-19794-7_ENCRYPTED_BINARY"]:sigSDK.IsoType["ISO-19794-7_BINARY"],a)?readSignature(!0):(document.getElementById("load_signature").value=null,alert("Incorrect signature data found"),emptyLoadData())}}catch(a){document.getElementById("load_signature").value=null,alert(a),emptyLoadData()}},e.readAsArrayBuffer(t)}};function emptyLoadData(){document.getElementById("load_who").innerHTML="",document.getElementById("load_why").innerHTML="",document.getElementById("load_when").innerHTML="",document.getElementById("load_extra_data").innerHTML="",document.getElementById("load_digitizer_type").innerHTML="",document.getElementById("load_digitizer_driver").innerHTML="",document.getElementById("load_operating_system").innerHTML="",document.getElementById("load_network_interface_card").innerHTML="",document.getElementById("load_licence").innerHTML="",document.getElementById("load_integrity").innerHTML="",document.getElementById("document_load").disabled=!0,document.getElementById("signatureImage_loaded").style.display="none",document.getElementById("signatureimage_loaded_background").style.display="block"}async function readSignature(t){try{const e=await renderSignatureImage();document.getElementById("load_who").innerHTML=mSigObj.getWho(),document.getElementById("load_why").innerHTML=mSigObj.getWhy();let n=mSigObj.getWhen();document.getElementById("load_when").innerHTML="The signature was captured on "+n,document.getElementById("load_extra_data").innerHTML=mSigObj.getExtraData(""),document.getElementById("load_digitizer_type").innerHTML=mSigObj.getAdditionalData(sigSDK.CaptureData.Digitizer),document.getElementById("load_digitizer_driver").innerHTML=mSigObj.getAdditionalData(sigSDK.CaptureData.Digitizer_Driver),document.getElementById("load_operating_system").innerHTML=mSigObj.getAdditionalData(sigSDK.CaptureData.Machine_OS),document.getElementById("load_network_interface_card").innerHTML=mSigObj.getAdditionalData(sigSDK.CaptureData.Network_Card),document.getElementById("load_licence").innerHTML=mSigObj.getLicence();const a=[sigSDK.KeyType.MD5,sigSDK.KeyType.SHA1,sigSDK.KeyType.SHA224,sigSDK.KeyType.SHA256,sigSDK.KeyType.SHA384,sigSDK.KeyType.SHA512];for(let d=0;d<a.length;d++)try{let o=await mSigObj.checkIntegrity(a[d]);if(o==sigSDK.IntegrityStatus.OK){document.getElementById("load_integrity").innerHTML='<span style="color:green">The signature integrity is correct.</span>';break}else if(o==sigSDK.IntegrityStatus.MISSING){document.getElementById("load_integrity").innerHTML='<span style="color:black">No Integrity data found.</span>';break}else if(o!=sigSDK.IntegrityStatus.WRONG_TYPE){document.getElementById("load_integrity").innerHTML='<span style="color:red">'+sigSDKHelper.integrityStatusDesc(o)+"</span>";break}}catch{}document.getElementById("document_load").disabled=!1,document.getElementById("signatureImage_loaded").src=e,document.getElementById("signatureImage_loaded").style.display="block",document.getElementById("signatureimage_loaded_background").style.display="none"}catch(e){return document.getElementById("load_signature").value=null,t&&alert(e),!1}return!0}window.checkDocumentHash=async function(){const t=new FileReader;t.onload=async function(){try{const e=t.result,n=[sigSDK.KeyType.MD5,sigSDK.KeyType.SHA1,sigSDK.KeyType.SHA224,sigSDK.KeyType.SHA256,sigSDK.KeyType.SHA384,sigSDK.KeyType.SHA512];for(let a=0;a<n.length;a++){const d=n[a];let o=new sigSDK.Hash(d);if(await o.add(e)){const r=await mSigObj.checkSignedData(o);if(r!=sigSDK.DataStatus.BAD_TYPE){alert(sigSDKHelper.dataStatusDesc(r));break}}else{alert("Failed to load file");break}o.delete()}}catch(e){alert(e)}},t.readAsArrayBuffer(document.getElementById("document_load").files[0])};window.removeButton=function(t){document.getElementById(t).remove()};window.addButton=function(){const t=document.createElement("div"),e="btn_div_"+new Date().getTime();let n='<fieldset id="'+e+`"><p><label for="button_text">Button Text:</label><input type="text" name="button_text"></p><p><label for="button_action">Action:</label><input type="text" name="button_action"></p><p><label for="button_text_color">Text color:</label><input type="color" name="button_text_color" value="#000000"></p><p><label for="button_background_color">Background color:</label><input type="color" name="button_background_color" value="#e7e7e7"></p><p><label for="button_border_with">Border width:</label><input type="text" name="button_border_width" value="1"></p><p><label for="button_border_color">Border color:</label><input type="color" name="button_border_color" value="#cccccc"></p><p><button onClick="removeButton('`+e+`')">Remove</button></p></fieldset>`;t.innerHTML=n,document.getElementById("button_list_div").appendChild(t)};window.addExtraData=function(){const t=document.createElement("div"),e="extra_data_div_"+new Date().getTime();let n='<fieldset id="'+e+`"><label for="extra_name_text">Name:</label><input type="text" name="extra_name"><br><br><label for="extra_value">Value:</label><input type="text" name="extra_value"><br><br><button onClick="removeExtraData('`+e+`')">Remove</button></fieldset>`;t.innerHTML=n,document.getElementById("extra_data_list_div").appendChild(t)};window.removeExtraData=function(t){document.getElementById(t).remove()};function generateExtraData(){const t=[],n=document.getElementById("extra_data_list_div").getElementsByTagName("fieldset");for(var a=0;a<n.length;a++)t.push({name:n[a].elements.namedItem("extra_name").value,value:n[a].elements.namedItem("extra_value").value});return t}async function encryptSignature(){try{if(document.getElementById("no_encryption").checked)await mSigObj.setPublicKey(""),await mSigObj.setPrivateKey("");else{if(document.getElementById("symmetric_encryption").checked)await mSigObj.setEncryptionPassword(document.getElementById("symmetric_password").value);else if(document.getElementById("asymmetric_encryption").checked){const t=document.getElementById("public_key").value;t!==""&&await mSigObj.setPublicKey(t)}mSigObj.canEncrypt()||alert("The signature cannot be encrypted")}}catch(t){alert(t)}}async function decryptSignature(t){try{if(document.getElementById("symmetric_encryption").checked)await t.setEncryptionPassword(document.getElementById("symmetric_password").value);else if(document.getElementById("asymmetric_encryption").checked){const e=document.getElementById("private_key").value;if(e!==""){const n=document.getElementById("private_key_password").value;n!==""&&(e+=","+n),await t.setPrivateKey(e)}}}catch(e){alert(e)}}function timeOutCallback(t){if(parseInt(document.getElementById("minTimeOnSurface").value)<t){const n=document.getElementById("dataTimeOut");n.options[n.selectedIndex].value=="accept"?accept():cancel()}else{const n=document.getElementById("emptyTimeOut");n.options[n.selectedIndex].value=="accept"?accept():cancel()}}
